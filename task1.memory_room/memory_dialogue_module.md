# 对话记忆保持模块设计

首先，我基于一个原则逻辑：人的一切情绪问题主要来自人际关系，所以我以此为基础进行设计
（后面我会优化逻辑！最重要的事情只有一件，先完成再完美，先把这个逻辑做好先）

## 一、模块目标

该模块用于
1.保持 AI 与用户之间的“信息延续性”，避免多轮对话中上下文丢失、重复提问等问题，从而实现更自然、更个性化的交互体验。
2.记录用户偏好,情绪,人际关系等

---

## 二、模块拆解

### 1. 信息压缩MemoryRoom

为避免上下文信息膨胀，需要将用户相关信息进行压缩存储和提取总结，具体包括以下四类：
(在Memory设计上1.1和1.3是一个MemoryRoom,1.2是一个MemoryRoom)

1.1 用户当前情绪记录

- 示例：焦虑、开心、压力大等  
- 可通过关键词或情感识别模型提取

1.2 用户个性化偏好记录  

- 示例：喜欢被鼓励、不喜欢直接命令式语气、偏好英文回复  
- 可通过显式偏好（“我不喜欢这样说话”）或隐式交互总结

1.3 用户人际关系记录  
**这个很重要！人际关系是我们的主键！我们后续也会根据人际关系的变化进行更新**

- 示例：用户提到“女朋友因为加班和我争吵,感到很不安”、“导师打压论文导致很挫败”等  
- 用于后续引用，形成亲密感和上下文一致性

2信息压缩实现  

- 将以上信息存为结构化摘要，例如 JSON：
  **记住我们的主键始终是人际关系！**
  然后这里的时间很重要，因为情绪和人际关系是随着时间变化的，并且我们需要对情绪进行归因,需要一个主键,所以我的设计是把他们放在一起,并且通过时间和事件进行定位,所以他们俩放一个房间emo_room,而偏好在preference_room
  
  

```json
[
  {
    "person": "女朋友",
    "relation": "伴侣",
    "event": "最近因为加班太多产生争吵",
    "emotion": "紧张 / 不安",
    "timestamp": "2025-05-29"
  },
  {
    "person": "导师",
    "relation": "学术指导",
    "event": "对我的论文表达了不满",
    "emotion": "挫败 / 压力大",
    "timestamp": "2025-05-28"
  }
]
```

```python
{
  "style_preferences": [
    {
      "type": "回应风格",
      "preference": "喜欢被鼓励",
      "evidence": "用户表达出喜欢鼓励性语言",
      "timestamp": "2025-05-25"
    },
    {
      "type": "回应风格",
      "preference": "不喜欢命令式语气",
      "evidence": "用户曾表示“你不要这样命令我”",
      "timestamp": "2025-05-20"
    }
  ],
  "language_preferences": [
    {
      "type": "语言风格",
      "preference": "偏好英文回复",
      "evidence": "多次使用英文进行提问",
      "timestamp": "2025-05-26"
    }
  ],
  "interaction_preferences": [
    {
      "type": "互动方式",
      "preference": "喜欢被主动关心",
      "evidence": "用户提到“你可以问问我最近过得怎么样”",
      "timestamp": "2025-05-27"
    }
  ]
}

```



### 2. 插入位置 MemoryInteraction

（现在先这么设置，项目跑起来了根据实际测试对话数据优化迭代！）

压缩后的信息需要合理插入到 Prompt 中以指导模型生成：

| 插入位置                | 适用信息类型                                                 | 优点                                     | 缺点                             | 示例用途                                     | 对应                  |
| ----------------------- | ------------------------------------------------------------ | ---------------------------------------- | -------------------------------- | -------------------------------------------- | --------------------- |
| **System Prompt**       | 用户**长期**属性（用户人设和身份、人际关系、偏好、角色设定） | 模型全程“记住”这些信息，生成更连贯的回复 | 可能限制模型发挥（Prompt死板？） | 你是一个心理咨询AI，用户叫Lisa，喜欢温柔风格 | preference_room<br /> |
| **User Prompt Comment** | **近期**对话背景，近期事件和情绪（如用户Lisa今天考研失败了，感觉很失落） | 精准控制模型对最近上下文的感知           | 可能被忽略，位置靠后             | Lisa刚刚说她和男朋友吵架，情绪焦虑           | emo_room              |

System Prompt情况举例说明：
如“用户是女生”、“用户偏好共情语气”、“她的导师常打压她”
如：“请你始终以温柔安慰的风格回应此用户”

```python
System Prompt:
你是一个温柔善解人意的心理咨询AI，面对用户Lisa时请格外注意共情回应。她内心特别敏感，情绪容易焦虑，自尊心强。
```

user Prompt后注释情况举例说明：

如用户发送：考研失败了，完蛋了！
后续用户发送：我今天仍然感觉压力很大

```python

User: 考研失败了，完蛋了！
AI:xxxxxxxxxxxxx
......
......

User:我今天仍然感觉压力很大
# Memory:用户在5.29日因为考研失败这件事情感觉很沮丧
AI:xxx

```

总结：
我们对于每一个用户，只需要给这个用户在数据看里面实例化一个SynAI_Room即可
这个Room由emo_room,preference_room,dialogue_room组成
其中preference_room插入在SystemPrompt里面
emo_room插入到User后面的对话（通过# Memory）  
（现在姑且这么处理，如果用RAG，会影响交互速度，而且提升也没多大，这个看后面测试版本运行效果来定，先把事情往简单的方式处理，不增加额外步骤）
dialogue_room对应的就是messages
那么我们实际上就是存储三个变量啦，这种设计可行性高，而且性能和速度都好
(我个人不建议初期就把项目往复杂了搞，越简单的架构越难设计，但越有效，先把当前问题解决)



### 3. 更新时间点MemoryUpdate

系统在以下时机触发信息压缩更新：

- **人际关系改善**（如：太好啦！我跟女朋友说明了之所以加班是为了能够尽早买房结婚，女朋友对我加班情况表示了理解！我感觉很欣慰。）
- **用户明确表达变化**（如：“我好多了”，表示情绪改善）
- **情绪趋势反转**（如连续几轮情绪从负面转为积极）
- **新增重要事实信息出现**（如：“我搬去上海了”，“我考上了研究生”，“我结婚了”，“我找到了工作”）
- **关键词触发更新**：预设词汇表匹配，包含涉及到人际关系、人名的词汇和情绪词汇（如“女朋友”、“最近焦虑”）

更新机制策略：

```json
TIPS:
这里是prefer-performance策略，后面会有speed策略，和中和策略
即我们可以对messages批量处理，多少轮进行一个处理,而不是对每个当前轮处理
这样的优点是响应更快，缺点是不一定能够实时掌握用户情绪状态
(这里的情绪分类肯定要用大模型，这样就需要个1-2s时间，所以每轮都处理会影响speed)
这个后面再调，相当于一个超参数
```



- 对每轮用户输入运行关键词提取 + 情绪分类器
  - 关键词提取后的触发器
    触发条件：比如女朋友，<女朋友的姓名>，好友，<好友的姓名>，父母，<父母的姓名>等
    (暂时先不设计姓名相关的,可能涉及到隐私相关,具体实现先只根据身份不根据姓名)
  - 情绪分类后的触发器
    触发条件：当情绪波动时，即很差或者很好时促发，情绪平淡时不必触发
    特点是不仅是用户主动说,而是用户的语气表明了他状态不好有情绪
- 匹配到触发条件即更新memoryroom存储状态

## 三、模块展示

具体见两个流程图emotional_memoryroom_structure和emotional_memoryroom_update

## 四、完整交互模拟(Demo版本)

```python
User: 考研失败了，完蛋了！
AI: 听到你考研失败的消息我感到很遗憾，这对你一定是一个很大的打击。你已经努力了很久，允许自己难过一下是很正常的。如果你愿意，我们可以一起聊聊接下来的方向，或者只是让我陪你说说话也可以。

# Memory 更新：
{
  "person": "自我",
  "relation": "用户本人",
  "event": "考研失败",
  "emotion": "沮丧 / 崩溃",
  "timestamp": "2025-05-29"
}
......
User: 我今天仍然感觉压力很大
# Memory: 用户在2025-05-29因为考研失败感到沮丧
AI: 你前几天提到因为考研失败感到很沮丧，我能理解这种情绪可能还没那么快缓解。今天感觉压力很大，是因为还在为未来做打算吗？想说说是什么让你特别紧张吗？我在这儿，陪你慢慢整理思绪。
```

回复点评:

| 模块     | 设计说明                                           |
| -------- | -------------------------------------------------- |
| 情绪共情 | 用“允许自己难过”、“很遗憾”等表达，避免打鸡血式回应 |
| 记忆引用 | 用“你前几天提到...” 引出过去事件，建立连续性       |
| 问题引导 | 提出开放式问题，引导用户表达更深层次原因           |
| 结构清晰 | 先回应情绪，再递进式陪伴引导，增强人性化           |

(后面改进思路：
具体怎么样的情绪引导策略及跟心理学有关的部分 
寻求同事协作+我学习最前沿有效的相关心理学知识)
